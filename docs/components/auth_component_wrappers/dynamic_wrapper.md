# Динамический авторизационный компонент (ДАК).

## Содержание
+ [Описание компонента](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Описание-компонента)
+ [Цели и задачи](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Цели-и-задачи)
+ [Состав компонента](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Состав-компонента)
+ [Стилизация компонента](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Стилизация-компонента)
+ [Где лучше размещать компонент](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Где-лучше-размещать-компонент)
+ [Пример инициализации](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component_wrappers/dynamic_wrapper.md#Пример-инициализации)


## Описание компонента

  Если говорить по простому, то ДАК - это авторизационный компонент (ак) в попапе.
  Сразу стоит отметить, что это именно ак в попапе. Он не входит в состав другой формы (другого компонента), а является независимым компонентом (самодостаточной формой), показываемым в попапе.
  (Для работы с ак, входящими в состав другой формы, необходимо использовать статический ак).


## Цели и задачи

  В чём необходимость выделять ак в попапе в отдельную сущность?

  Мы очень часто используем попапы. Да что уж там - мы юзаем их даже там, где и не следовало бы.
  И зачастую нам приходится выводить в попапе пару полей для авторизации, по резельтатам успешного заполнения и отправки данных которых,
  мы создаём отзыв, подписываемся на акции, на посты. Иначе говоря, с ДАК мы имеем дело очень часто.

  Это приводит к тому, что нам каждый раз нужно по одной и той же схеме инициализировать данный компонент.
  А зачастую ДАК - это зависимость для какого-либо основного модуля (модуль отзывов, подписки на акции и пр.). А значит
  нам нужно каким-то образом обеспечить взаимодействие между модулями.
  А это приводит к тому, что мы зачастую жёстко связываем две сущности - напрямую инициализируем один компонент в другом, даём много лишней информации одному компоненту о другом.
  Такой код сложнее поддерживать; практически на нет сводится взаимозаменяемость модулей; и тестировать такой код очень и очень сложно.

  ДАК призван решить две эти проблемы:
  - избежать необходимости писать везде одно и тоже;
  - декомпозировать модули.


## Состав компонента

  Динамический авторизационный компонент состоит из трёх основных частей:

  1. ### Конфиг.
  Это первая и основная часть ак. Здесь задаются опции для ак, подробно описанные в [этой документации](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component.md).

  *Пример*

  ``````javascript
  'app.config.authComponent.wrappers.dynamic': {
    'sign-in': {
      type: 'form',
      popup: {},
      orientation: 'vertical',
      toggleContent: true,
      withMultipleField: true,
      contentType: 'sign-in',
      fields: { hiddenByDefault: ['name'] },
      actionOnSuccess: 'reload',
      containerName: 'signIn',
    }
  }
  ``````

  Итак, при создании конфига нужно:

  - Определиться с названием типа ак. Он послужит неймспейсом для опций ак. В данной ситуации `sign-in` - тип ак.
  - Разместить конфиги в соответствующем неймспейсе. Все конфиги должны быть размещены по данному пути: `app.config.authComponent.wrappers.dynamic`.

  2. ### Модуль-контейнер ак.

  Зачастую нам необходимо обработать результаты авторизации/регистрации, валидации ак и выполнить по результатам данных процессов определённые действия.
  Делать это необходимо в модулях-контейнерах.

  Эти модули имеют привычную для нас структуру, практически не отличающуюся от структуры основных модулей:

  ````````javascript
  app.modules.signInAuthComponentContainer = ((self) => {

    self.getOptions = () => ({
      onMount() {
        $doc.trigger('closeAllPopup:popups');
      },
      onCompleted() {
        location.reload(true);
      },
    });

    return self;

  })(app.modules.signInAuthComponentContainer || {});
  ````````

  Единственным отличием является то, что основным методом такого модуля является метод getOptions, который должен
  возвращать объект с коллбэками для обработки данных на разных этапах работы ак.

  Коллбэки должны иметь строго определённые названия. Весь доступный перечень таких коллбэков и их назначение подробно описаны
  в [документации ак](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component.md#Коллбэки)
  (но если вы считаете, что не совсем подробно, то обязательно дайте об этом знать группе Пользователей).

  В данном примере используется два коллбэка:

  - onMount триггерит событие на закрытие попапов как только компонент вставлен в попап.
  - onCompleted перезагружает страницу по факту успешной авторизации/регистрации пользователя.

  Стоит отметить, что контейнер может вовсе отсутствовать, если ваша задача исключает необходимость каким-либо образом
  обрабатывать результаты работы ак.

  3. ### Контроллер или событие.

  Чаще всего точкой входа в ДАК служит ссылка, при клике по которой должен показываться компонент.
  В данной документации эту точку входа мы называем контроллером.

  Правильный контроллер должен отвечать ряду требований:

  - Иметь класс `js-show-dynamic-auth-component`.
  - Содержать data-атрибут `data-auth-component-type` с типом авторизационного компонента.

  **Пример**

  ````html
  <a href='#' class='js-show-dynamic-auth-component' data-auth-component-type='some-type'>
    Click Me And You'll See DAC
  </a>.
  `````

  К слову, контроллер может и не содержать data-атрибут. В этом случае по дефолту контроллер
  будет инициализировать компонент типа sign-in.

  Но иногда вы захотите показать компонент без физического контроллера на странице.

  Например, при попытке выполнить подписку вы проверяете авторизован пользователь или нет, и в случае отсутствия пользовательской сессии
  показываете ДАК для предварительной авторизации перед совершением подписки.

  Реализовать данную задачу можно с помощью триггера события `show:dynamicAuthComponent`:

  ````javascript
  $doc.trigger('show:dynamicAuthComponent', ['sign-in']);
  `````

  В качестве единственного аргумента вам необходимо передать название типа ак, который вы хотите отобразить на странице в данный момент.


## Стилизация компонента.

  При инициализации компонента контейнеру компонента присваивается класс `auth-component-${type}`.

  Здесь `type` - тип компонента.

  Этот класс вы можете использовать для точечной стилизации компонента.


## Где лучше размещать компонент.

  1. ### Модуль контейнера.

  Прежде всего рекомендуется для всех компонентов (не только авторизационного) создавать папку javascripts/components.
  Соответственно под компонент в данной папке мы создаём папку auth_component. В ней создаём папку containers, в которой в свою очередь
  размещаем модyли всех ДАК.
  Модули должны носить названия, совпадающие с названиями типов ак.

  **Пример**

  Тип ак: `sign-in-type`
  Название файла: `sign_in_type.js`

  Сам же модуль должнен носить такое имя: `signInTypeAuthComponentContainer`.

  То есть к названию типа(в camelCase) добавляете `AuthComponentContainer`.

  **Пример**

  `````text
  // Здесь сидит модуль-контейнер ак типа some-type-name
  /javascripts
  /components
    /auth_component
      /containers
        /some_type_name.js // Название модуля - someTypeNameAuthComponentContainer
  ``````


  2. ### CSS для компонента.

  По аналогичному принципу предлагается размещать и стили ак.

  **Пример**

  `````text
  // Здесь сидят стили для ак типа some-type-name
  /stylesheets
  /components
    /auth_component
      /containers
        /some_type_name.scss
  `````


  3. ### Конфиг и контроллер.

  Сам конфиг компонента следует размещать ближе к вьюхе с контроллером.
  Например, в вашем приложении имеется блок с кнопкой (контроллером), при клике по которой должен инициализироваться ДАК.
  Сидит этот блок в партиале _some_block_with_button.html.haml
  Рядом с этим парртиалом создаём отдельный файл для конфиrа(!) и определяем его там.

  Сам конфиг рендерится в блоке с кнопкой. Таким образом, куда бы вы не перенесли этот блок, вы всегда перенесёте его
  вместе с конфигом.

  **Пример**

  ````text
  /subscriptions
    _block_with_button // Здесь сидит контроллер
    _app_config // Здесь инициализируется конфиг ак
  `````

  _app_config рендерится в _block_with_button.


## Пример реализации.

  В качестве примера реализации я приложу ссылки на части ДАК в Пульсе Цен.
  На данном проекте с помощью ДАК реализован основной попап регистрации/авторизации.

  1. [Конфиг](https://github.com/abak-press/apress-clearance/blob/reg-by-email/app/views/apress/clearance/require/_auth_component_config.html.haml#L28)

  "Почему конфиг размещён в apress-clearance? Нам тоже там конфиги размещать?"

  Конфиг размещён в apress-clearance, поскольку это конфиг для первой реализации динамического ак и размещён в геме для примера - как он должен выглядеть.
  Конфиги в apress-clearance размещать не нужно.
  Конфиги динамических ак должны быть размещены либо в геме, отвечающем за реализацию сервиса, который требует наличие ак; либо в проекте.

  2. [Контейнер динамического ак типа `sign-in`](https://github.com/abak-press/pulscen/blob/reg-by-email/app/assets/javascripts/components/auth_component/containers/sign_in.js).

  Данный контейнер содержит только один коллбэк `onMount`, который вызывается при вставке ак в попап. Подробно о всех доступных
  к использованию коллбэках читайте в соответствующем разделе [документации ак](https://github.com/abak-press/apress-clearance/blob/reg-by-email/docs/components/auth_component.md#Коллбэки).

  3. [Контроллер для вызова ДАК](https://github.com/abak-press/pulscen/blob/reg-by-email/app/views/shared/_auth_link.html.haml#L4).

  4. Стили. Стили для компонента данного типа не переопределялись - используются дефолтные.
