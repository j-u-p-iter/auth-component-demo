# Авторизационный компонент.

## Содержание
+ [Описание компонента](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Описание-компонента)
+ [Стадии работы компонента](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Стадии-работы-компонента)
+ [Подключение компонента](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Подключение-компонента)
+ [API компонента](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#api-компонента)
+ [Опции](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Опции)
  + [Общие опции](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Общие-опции)
  + [Опции для конфигурации полей компонента](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Опции-для-конфигурации-полей-компонента)
+ [События](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#События)
+ [Глобальные конфиги](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Глобальные-конфиги)

## Описание компонента.

Авторизационный компонент - это набор полей формы, отображаемых в определённой последовательности.
Компонент состоит из четырёх полей: `email`, `phone`, `password`, `name` и служит для следующих целей:


1. ### Регистрации/авторизации юзера.

   Помимо обычной регистрации (с использованием стандартных авторизационных данных), предусмотрена авторизация с использованием SID.

   SID - это случайно генерируемый набор символов, позволяющий с большой долей вероятности обеспечить уникальность сессии юзера, регистрируемого с
   использованием данного идентификатора.


2. ### Повышения авторизационного уровня уже авторизованного пользователя.

   В настоящий момент пользователь может обладать одним из трёх уровней авторизации: `sid`, `phone`, `email`. `sid` - самый низкий уровень авторизации. `email` - самый высокий.

   Уровень авторизации определяется заполненностью полей пользователя `phone` and `email` реальными данными.
   Если пользователь имеет электронной адрес (телефон может как присутствовать, так и отсутствовать), то его авторизационный уровень - `email`.
   Если пользователь имеет только телефон, то его авторизационный уровень - `phone`.
   Если пользователь зарегистрирован по `sid`, то поле `phone` данных не содержит, поле `email` содержит фейковое мыло, и авторизационный уровень такого пользователя - `sid`.

   О текущем уровне авторизации пользователя можно узнать исходя из заполненности того или иного поля пользователя.
   Например, чтобы узнать, зарегистрирован ли пользователь по мылу - нужно проверить поле email пользователя на наличие данных.


3. ### Mёрджа данных одного пользователя в данные другого.

   Решение о том авторизовывать пользователя или регистрировать; повышать ли уровень авторизации пользователя или производить мёрдж пользователей компонент принимает исходя из:

   1. Набора данных, которыми заполнен компонент.
   2. Текущего уровня авторизации пользователя.

Подробно о том, что такое повышение уровня авторизации, мёрдж пользователей и для чего служат данные процессы - читайте [здесь](https://conf.railsc.ru/pages/viewpage.action?pageId=36443479).


## Стадии работы компонента.

Рассмотрим в общих чертах, как работает компонент. Следует различать 4 стадии, которые проходит компонент при работе:

1. Валидация введённых данных.
   Итак, первый цикл - валидация данных. Данные полей валидируются при потере фокуса всех полей, кроме password.
   Если значения хотя бы одного из полей невалидны, то дальнейшие стадии не наступают. Компонент будет ждать, когда будут введены корректные валидационные данные.

2. Поиск пользователя по определённому алгоритму.
   С алгоритмом поиска пользователя вы можете ознакомиться по данной [ссылке](https://conf.railsc.ru/pages/viewpage.action?pageId=36443479).
   После успешной валидации данных следует поиск пользователя. Поиск также осуществляется при потере фокуса всех полей, кроме password.

   Дальнейшие стадии наступают при отправке пользователем данных авторизационного компонента.
   Итак, мы ввели корректные данные, нашли/или не нашли юзера, исходя из данных, введенных в компонент, и хотим отправить данные.
   Для отправки данных нужно триггерить на компоненте событие (об API компонента читайте [далее](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#api-компонента)).
   Триггерим событие, в результате чего наступают следующие две стадии работы компонента.

3. Повышение уровня авторизации пользователя или мёрдж пользователя.
   Подробнее о том, что это такое и для чего - читайте [здесь](https://conf.railsc.ru/pages/viewpage.action?pageId=36443479).
   Это необязательная стадия. Она может отсутствовать, поскольку не всегда нам нужно что-то кому-то повышать или что-то во что-то мёрджить.

4. Регистрация и/или авторизация пользователя.
   После успешно пройденных предыдущих стадий наступает последняя стадия регистрации/авторизации пользователя.

Все стадии работы компонента выполняются последовательно, поскольку на каждом следующем этапе нам важно знать результаты выполнения предыдущего цикла.
По результатам выполнения всех стадий - компонент даёт знать о том, успешно или не успешно они выполнились. Этот результат можно и нужно
обработать. О том, как получить и обработать результат работы компонента читайте [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#processuserdataauthcomponent).


## Подключение компонента.

Для того, чтобы подключить компонент, необходимо:

1. ### Подключить css && js ассеты компонента.
   Подключение js:
   ``````javascript
   //= require package/clearance/auth_component
   ``````

   Подключение css:
   - для десктопной версии:
   ``````css
   *= require package/clearance/desktop/auth_component
   ``````
   - для мобильной версии:
   ``````css
   *= require package/clearance/mobile/auth_component
   ``````

2. ### Отрендерить контейнер компонента.

   Контейнер служит:
   1. Для хранения опций, которые используются компонентом при инициализации. Опции служат для конфигурации компонента.
      Для каждой опции предусмотрено дефолтное значение, поэтому инициализация компонента возможна без проброса опций.

      Подробнее об опциях и их дефолтных значениях - [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Опции).

   2. В качестве обёртки для самого авторизационного компонента.
      После инициализации сам компонент рендерится внутри данной обёртки.

      Подробнее о том, как инициализировать компонент - [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#renderauthcomponent).

   При рендере компонента можно пробросить опции, которые будут записаны в data-атрибут контейнера и использованы при инициализации компонента.

   **Пример**

   Отрендерим контейнер компонента. При этом отрендерим авторизационный компонент и зададим компоненту вертикальную ориентацию.

   `````ruby
   = render 'apress/clearance/shared/auth_component_container',
            orientation: 'vertical'
   `````

3. ### Проинициализировать компонент.

   Для инициализации компонента используется событие [render:authComponent](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#renderauthcomponent).
   Триггерить его необходимо на элементе контейнере. Таким образом можно лениво инициализировать отдельно друг от друга произвольное количество авторизационных компонентов
   (ну если оно вам действительно нужно).

   **Пример**

   Проинициализируем авторизационный компонент.

   `````javascript
   var $container = $('.js-auth-component-container');

   $container.trigger('render:authComponent');
   `````

   Стоит отметить, что по дефолту контейнер имеет класс js-auth-component-container. Именно его необходимо использовать для формирования селектора с целью инициализации компонента.

   Но вы также можете легко переопределить данное дефолтное значение класса, пробросив при рендерингe контейнера [(см. предыдущий пункт)](https://github.com/abak-press/apress-clearance/blob/auth-compoent/docs/components/auth_component.md#Отрендерить-контейнер-компонента) параметр class_name, указав нужное имя класса:

   ````ruby
   # some_view.html.haml

   = render 'apress/clearance/shared/auth_component_container', class_name: 'js-container-new-container'
   ````

   И тогда инициализировать компонент уже будем на контейнере с классом 'js-auth-container-new-container':

   ````javascript
   var $container = $('.js-auth-component-new-container');

   $container.trigger('render:authComponent');
   `````

   В итоге мы получим компонент в месте рендеринга контейнера, проинициализированный с дефолтными [опциями](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Опции).

### API компонента

Для гибкого использования компонента необходимо знать его API. Рассмотрим его.

### Опции
Для начала рассмотрим опции, которые могут быть использованы для гибкой конфигурации компонента под самые различные нужды.
Условно опции делятся на общие - касающиеся всего компонента в целом, и на опции для конфигурации полей, использующиеся для точечной конфигурации полей компонента.
Давайте последовательно рассмотрим их.

#### Общие опции

##### `title`

+ **Тип данных:** Строка.
+ **Описание:** Служит для присвоения компоненту заголовка.

  Заголовок выводится сверху - над всеми полями компонента.
+ **Доступные значения:** Любое строковое значение
+ **Значение по умолчанию:** Пустая строка.

##### `buttonText`

+ **Тип данных:** Строка.
+ **Описание:** Служит для присвоения текста для кнопки компонента.

  Опция актуальна для компонентов с типом [form](https://github.com/abak-press/apress-clearance/blob/auth-component/docs/components/auth_component.md#type),
  поскольку только компоненты данного типа содержат в своём составе кнопку.
+ **Доступные значения:** Любое строковое значение.
+ **Значение по умолчанию:** null.

##### `tip`

+ **Тип данных:** Строка.
+ **Описание:** Служит для присвоения текста для подсказки рядом с кнопкой компонента.

  Опция актуальна для компонентов с типом [form](https://github.com/abak-press/apress-clearance/blob/auth-component/docs/components/auth_component.md#type),
  поскольку только компоненты данного типа содержат в своём составе кнопку.
+ **Доступные значения:** Любое строковое значение.
+ **Значение по умолчанию:** null.

##### `orientation`

+ **Тип данных:** строка.
+ **Описание:** Служит для указания способа ориентации компонента.

  Горизонтальная ориентация - две колонки по два поля.
  Вертикальная ориентация - все 4 поля в одну колонку.

+ **Доступные значения:** horizontal || vertical.
+ **Значение по умолчанию:** horizontal.
  По умолчанию компонент имеет горизонтальную ориентацию.

| Горизонтальная ориентация | Вертикальная ориентация |
| ------------------------- | ----------------------- |
| ![Горизонтальная ориентация](https://github.com/abak-press/apress-clearance/blob/master/docs/img/auth_component_horizontal.png?raw=true) | ![Вертикальная ориентация](https://github.com/abak-press/apress-clearance/blob/master/docs/img/auth_component_vertical.png?raw=true) |

##### `selectors`

+ **Тип данных:** Объект.
+ **Описание:** Набор селекторов внешних компонентов, с которыми может взаимодействовать авторизационный компонент.

Авторизационный компонент ничего не знает о внешних элементах. У него есть знание только о контейнере (косвенное) и элементах, составляющих сам авторизационный компонент.
Однако у вас может возникнуть необходимость каким-то образом обратиться к внешним элементам (целевым элементам). Данная опция используется для того, чтобы пробросить селекторы таких элементов авторизационному компоненту.
Например, у вас может возникнуть задача показать сообщение об ошибке вне пределов авторизационного компонента.
Авторизационный компонент в курсе, что селектор может быть задан в пределах selectors.flashMessage. Если он найдёт таковой, то покажет
сообщение об ошибке в элементе с данным селектором. Если такого селектора по пути selectors.flashMessage компонент не обнаружит, то он вставит сообщение об ошибке в элемент, расположенный в пределах авторизационного компонента, предназначенный содержать такие сообщения об ошибках по умолчанию.

+ **Доступные значения:** selectors.flashMessage.
+ **Значение по умолчанию:** {flashMessage: null}.


##### `error`

+ **Тип данных:** Строка.
+ **Описание:**  Описание ошибки, если таковое не предусмотрено конфигом проекта.

Если в результате обращения компонента к серверу возникла ошибка, то
компонент ищет описание данной ошибки по статусу в глобальном конфиге проекта.
Поиск осуществляется по следующему пути: app.config.api.errorMessages[statusCode].
Здесь statusCode - переменная, содержащая строковое значение кода статуса ответа об ошибке.
Если в конфиге для статуса ошибки описание не предусмотрено, то выводится общее сообщение об ошибке, которое и задается данной опцией.

+ **Доступные значения:** Любое строковое значение.
+ **Значение по умолчанию:** null.


Мы с вами рассмотрели все общие опции, доступные в данный момент для конфигурации компонента.

**Пример**
Рассмотрим пример конфигурации компонента с использованием всего возможного набора параметров.

**Задача - подключить авторизационный компонент**
+ в from.html.haml
+ c заголовком 'Зарегистрироваться или авторизоваться'
+ с вертикальной ориентацией
+ с выводом flash-сообщения вне авторизационного компонента в элементе с селектором '.js-some-flash-message'

**Решение.**

`````ruby
// form.html.haml
= render 'apress/clearance/shared/auth_component_container’,
         title: ‘Зарегистрироваться или авторизоваться’,
         orientation: ‘vertical’,
         selectors: {flashMessage: ‘.js-some-flash-message'}'
`````

#### Опции для конфигурации полей компонента.
Теперь рассмотрим более специфичные опции компонента, позволяющие конфигурировать поля компонента.
Все опции, предназначенные для конфигурации полей, расположены в неймспейсе fields.

Прежде всего рассмотрим две основные опции, которые вы будете использовать чаще всего - `set` и `required`.

#### `set`

+ **Тип данных:** Массив.
+ **Описание:**
  Данная опция служит для двух целей:
  1. Задать набор полей, которые будут отображаться компонентом.
  2. Задать порядок полей, в котором поля будут отрендерены.

+ **Доступные значения:** Массив, содержащий названия полей компонента в произвольном порядке.
+ **Значение по умолчанию:** ['name', 'email', 'phone’].

По умолчанию поле пароль выводится всегда последним.
Если его порядок менять не нужно, то указывать его в массиве set необязательно.
При необходимости изменить место расположения поля пароль относительно других полей, его нужно напрямую указать в массиве. Допустим, мы хотим, чтобы поле пароль выводилось
после поля name; при этом порядок вывода остальных полей должен остаться неизменным. Тогда опции необходимо присвоить следующее значение: [’name’, ‘password’, ‘email’, ‘phone’].


#### `required`

+ **Тип данных:** Массив.
+ **Описание:** Данная опция служит для указания перечня обязательных полей.
Обязательность полей проверяется на первой стадии работы авторизационного компонента - 'Валидация компонента'.
Подробно о стадиях работы компонента читайте [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#Стадии-работы-компонента).

+ **Доступные значения:** Массив, содержащий названия полей компонента в произвольном порядке.
+ **Значение по умолчанию:** ['name', 'email', 'phone'].
  Таким образом, по умолчанию все поля являются обязательными.

Поля компонента, обязательные для заполнения, по умолчанию помечены звёздочкой, расположенной после лейбла поля. Есть звезда - поле обязательно для
заполнения. Нет - опциональное.

Перейдём к описанию остальных опций компонента.


#### `maxlength`

+ **Тип данных:** Объект.
+ **Описание:** Данная опция позволяет устанавливать атрибут maxlength индивидуально для каждого поля.

+ **Доступные значения:** Объект, содержащий значения атрибутов maxlength для каждого из полей компонента.
+ **Значение по умолчанию:** {name: 200}.


#### `hints`

+ **Тип данных:** Объект.
+ **Описание:** Позволяет настраивать подсказки для каждого из полей компонента (иконки, при взаимодействии с которыми показываются подсказки).
  Компонентом предполагается использование qtip для вывода подсказок, поэтому он ждёт hash для подсказок в формате,
  с которым работает стандартный qtip. Возможность использования компонента подсказок, отличного от qtip, в настоящий момент отсутствует.

+ **Доступные значения:** Объект, содержащий данные о подсказках для каждого из полей компонента.
+ **Значение по умолчанию:** null.
По умолчанию подсказки не выводятся.


#### `hiddenByDefault`

+ **Тип данных:** Массив.
+ **Описание:** Служит для скрытия по умолчанию набора полей, задаваемого данной опцией.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:** null.

Зачастую вам понадобится скрывать одно или несколько полей по умолчанию. Например, вам может понадобиться скрыть поле пароль
при рендеринге компонента и показывать его только в том случае, если пользователем введены корректные данные в остальные поля формы.
Для этого вам необходимо присвоить опции hiddenByDefault соответствующее значение:
hiddenByDefault: ['password']

Бывают и более сложные кейсы, когда, например, тот же поле пароль следует скрывать по умолчанию только для текущих юзеров, у которых заполнено поле телефон.
Для этого опция должна содержать следующее значение:
hiddenByDefault: ['password:phone'].
Читается так - скрыть поле телефон по умолчанию только для текущих пользователей, у которых заполнено поле phone.
Имя поля формы и поля текущего пользователя разделяются двоеточием. Сначала идёт имя поля формы, затем - имя поля пользователя.

Данная опция отвечает за скрытие полей компонента при его инициализации. На дальнейшую логику показа/скрытия полей данная опция не влияет.

Данная опция должна использоваться в сочетании с опцией `visibleIfDataCorrect` для всех полей, кроме поля password. Иначе поле будет скрыто по умолчанию и никогда не будет показано.
Подробнее об опции `visibleIfDataCorrect` - [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#visibleifdatacorrect).

Особняком стоит поле password. Поле пароля показывается/скрывается так, словно для него по умолчанию задана опция visibleIfDataCorrect, поэтому для данного поля достаточно указать hiddenByDefault. Моменты дальнейших показов/скрытий определит сам компонент.


#### `visibleForNewUsers`

+ **Тип данных:** Массив.
+ **Описание:** Служит для указания набора полей, которые должны быть показаны пользователям в том случае, если по результатам поиска пользователей (второй стадии работы компонента) - пользователь не найден.
Компонент скрывает поля, указанные в данной опции, по умолчанию. Поэтому для скрытия по умолчанию таких полей задавать опцию hiddenByDefault не нужно.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:** [].


#### `visibleIfDataCorrect`

+ **Тип данных:** Массив.
+ **Описание:** Служит для указания набора полей, которые нужно показывать в случае, если пользователем введены корректные данные.
  Иначе говоря, поля будут показаны в том случае, если успешно пройдена первая стадия работы компонента.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:** [].


#### `toCheckFormat`

+ **Тип данных:** Массив.
+ **Описание:** Служит для указания набора полей, которые будут проверены на корректность введённых данных на первой стадии работы компонента.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:**  ['name', 'email', 'phone'].
  Таким образом, поля name, email, phone валидируются по умолчанию.

#### `selfCleared`

+ **Тип данных:** Массив.
+ **Описание:** Служит для указания набора полей, для которых будет включена функция очищения поля.
  Для очищения поля компонентом используется иконка в виде крестика.
  Иконка отображается при условии заполненности поля данными. Клик по иконке очищает поле.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:** ['email', 'phone'].


#### `toSynchronize`
+ **Тип данных:** Массив.
+ **Описание:** Служит для указания набора полей, которые разрешено синхронизировать с аналогичными полями внешних компонентов.
  Если поле не перечислено в данном массиве, то попытка синхронизировать ни к чему не приведёт.

+ **Доступные значения:** Массив, содержащий произвольный перечень названий полей компонента.
+ **Значение по умолчанию:**  ['name', 'email', 'phone'].

О том, как настроить синхронизацию - читайте [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#synchronizefieldsauthcomponent).

#### `withoutLabels`
+ **Тип данных:** Логический.
+ **Описание:** Служит для указания - необходимо ли скрывать лейблы полей.

+ **Доступные значения:** true || false
+ **Значение по умолчанию:**  false.

#### `withoutPlaceholder`
+ **Тип данных:** Логический.
+ **Описание:** Служит для указания - необходимо ли скрывать плейсхолдеры полей.

+ **Доступные значения:** true || false
+ **Значение по умолчанию:**  false.

#### `inline`
+ **Тип данных:** Логический.
+ **Описание:** Служит для указания - необходимо ли выводить группы форм инлайного типа.

+ **Доступные значения:** true || false
+ **Значение по умолчанию:**  false.


#### `crossDomainAuth`
+ **Тип данных:** Логический.
+ **Описание:** Служит для указания - необходимо ли осуществлять кросс доменную авторизацию.

+ **Доступные значения:** true || false
+ **Значение по умолчанию:**  false.

Для осуществления кросс доменной авторизации используется модуль - app.modules.crossDomainAuthBridge.
Подробнее о данном модуле читайте [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#synchronizefieldsauthcomponent)

#### `popup`
+ **Тип данных:** Объект.
+ **Описание:** Служит для передачи опций для инициализации попапа, внутри которого необходимо отрендерить авторизационный компонент.
  В качестве зависимости для инициализации попапа используется UI Dialog.
  Интерфейс объекта с опциями для попапа аналогичен интерфейсу объекта с опциями для UI Dialog. Названия опций те же. Доступные значения опций те же.

+ **Доступные значения:** Объект, содержащий опции для инициализации попапа.
+ **Значение по умолчанию:** null.

+ **Пример**
  Допустим, перед нами стоит задача отрендерить авторизационный компонент в пределах попапа при клике по кнопке .js-button.

  `````javascript
  $('.js-button').on('click', function() {
    $('.js-auth-component-container').trigger('render:authComponent', [{
      popup: {
        dialogClass: 'some-auth-component-popup-class-name',
        onClose: function() {
          // to do something on popup close event
        }
      }
    }]);
  });
  `````
  Для того, чтобы инициализировать попап со стандартным набором опций, необходимо передать пустой объект в качестве значения опции popup.
  При этом попапу будет присвоен класс auth-component-popup.


#### `type`

+ **Тип данных:** Строка.
+ **Описание:** Служит для указания типа компонента.

  Следует различать два типа авторизационного компонента:

  1. **simple**. Компоненты данного типа не содержат элемента form в своём составе. То есть не являются формой, а представляют собой набор полей формы.
  Такие компоненты предназначены для интеграции в родительские компоненты-контейнеры - формы. Такое встраивание позволяет синхронизировать отправку данных
  авторизационного компонента и внешней формы контейнера.

  Допустим, перед вами стоит задача создать заказ с предварительной авторизацией пользователя на сайте. Это как раз случай использования данного компонента.
  Для решения данной задачи необходимо:
  + отрендерить форму заказа;
  + отрендерить в форме заказа авторизационный компонент типа simple;
  + на событие submit формы заказа выполнять сначала авторизацию пользователя, а потом отправку данных родетельской формы.

  2. **form**. Компонент данного типа можно охарактеризовать как самостоятельный. Сам компонент:
  + заключён в пределах элемента form;
  + содержит в своём составе кнопку для авторизации/регистрации пользователя.

  По нажатию на кнопку компонент авторизует/регистрирует пользователя или выводит сообщение об ошибке, которое говорит о том,
  что по той или иной причине данную операцию выполнить не удалось.

  На контейнере компонента можно слушать события, выполняющиеся по результатам работы компонента:
  + **afterAuthorizeWithSuccess:authComponent**. Событие, выполняющееся по результатам успешной авторизации/регистрации пользователя.
  + **afterAuthorizeWithError:authComponent**. Событие, выполняющееся в случае возникновения ошибки при авторизации/регистрации пользователя.

+ **Доступные значения:** simple || form.
+ **Значение по умолчанию:** simple.


#### `contentType`

+ **Тип данных:** Строка.
+ **Описание:** Служит для задания типа контента авторизационного компонента.

  Контентом компонента является содержимое:
  - заголовка (title);
  - текста кнопки (buttonText);
  - подсказки возле кнопки (tip).

  Тип контента компонента характеризует контент компонента для одного из трёх режимов:
  - режим авторизации (signIn). В данном режиме компонент используется для авторизции пользователя и содержит необходимый для этого набор полей.
  - режим регистрации (signUp). В данном режиме компонент используется для регистрации пользователя и содержит необходимый для этого набор полей.
  - общий режим (common). Режим, объединяющий в себе два предыдущих режима.

  Для каждого из обозначенных выше режимов можно задать контент.
  (текст заголовка, текст кнопки и текст подсказки возле кнопки). Контент задаётся через конфиг авторизационного компонента.

  **Пример**

  ````javascript
  app.utils.extendApp({
    'app.config.authComponent': {
      content: {
        signIn: {
          title: 'Hello! SignIn, Please!',
          buttonText: 'Push The Button'
        },
        signUp: {
          title: 'Hello! SignUp And Smile!',
          tip: 'You Should Be 100% Sure To Do It',
          buttonText: 'Push The Button'
        },
        common: {
          title: 'SignIn Or SignUp',
          tip: 'Are You Sure?',
          buttonText: 'Come on, Let's Do It!
        }
      }
    }
  })
  ````````

+ **Доступные значения:** 'sign-in' | 'sign-up' | 'common' | null.
  Присваивая опции значение 'sign-in', мы закрепляем за компонентом контент авторизационного типа (ключик signIn конфига, приведённого выше).
  Присваивая опции значение 'sign-up', мы закрепляем за компонентом контент регистрационного типа (ключик signUp конфига, приведённого выше).
  Присваивая опции значение 'common', мы закрепляем за компонентом контент общего типа (ключик common конфига, приведённого выше).

+ **Значение по умолчанию:** null.
  В случае значения null компонент не отрисует заголовок, кнопку и подсказку.


#### `toggleContent`

+ **Тип данных:** Логический.
+ **Описание:** Служит для указания - необходимо ли менять тип отображаемого контента (текст заголовка, текст кнопки, текст подсказки возле кнопки) в зависимости от режима компонента.
  О режимах компонента и соответствующих каждому из режимов типах контента - читайте [здесь](https://github.com/abak-press/apress-clearance/blob/master/docs/components/auth_component.md#contenttype).

+ **Доступные значения:** true | false.
  В случае присвоения данной опции значения true контент компонента будет меняться в соответствии с изменением режима компонента.
  В случае значения false - контент компонента будет закреплён в соответствии со значением опции contentType.

+ **Значение по умолчанию:** false.


#### `actionOnSuccess`

+ **Тип данных:** Строка или объект.
+ **Описание:** Служит для задания действия, которое необходимо совершить по факту успешной авторизации/регистрации.
+ **Доступные значения:** 'reload' | 'redirect="some-url-to-redirect-to"' | { signIn: 'reload', signUp: 'redirect="some-url-to-redirect-to"' }.

  Разберём детально каждое из возможных значений данной опции:
  - 'reload'. По факту успешной авторизации/регистрации компонент перезагрузит страницу.
  - 'redirect="some-url-to-redirect-to"'. По факту успешной авторизации/регистрации компонент перенаправит пользователя на "some-url-to-redirect-to".
  - { signIn: 'reload', signUp: 'redirect="some-url-to-redirect-to"' }.
    По факту успешной авторизации компонент перезагрузит страницу;
    по факту успешной регистрации компонент перенаправит на страницу "some-url-to-redirect-to".
+ **Значение о умолчанию:** null.


#### `withMultipleField`

+ **Тип данных:** Логический.
+ **Описание:** Позволяет отрендерить компонент с универсальным полем, в которое можно ввести как адрес электронной почты, так и телефон.
  Соответственно данный тип поля позволяет зарегистрироваться/авторизоваться как по телефону, так и по адресу электронной почты.

+ **Доступные значения:** true | false.
+ **Значение о умолчанию:** false.

+ **Примечание:**
  ##### Модификация опций, отвечающих за конфигурацию полей компонента при включённой опции withMultipleField.

  Все эти опции содержат массив с перечнем названий полей. И если, например, для какой-либо из
  данных опций присвоено значение ['name', 'email', 'password', 'phone'], то значение 'email' будет заменено
  на 'multiple', а значение phone исключено из массива. В результате значение опции, конфигурирующей поля компонента,
  будет ['name', 'multiple', 'password'].


#### `withToggledPassword`

+ **Тип данных:** логический.
+ **Описание:** переключатель иконки, позволяющей скрывать/показывать пароль.
  для очищения поля компонентом используется иконка в виде глаза.
  иконка отображается при условии заполненности поля данными.
  клик по иконке показывает пароль, а повторный клик скрывает пароль за стандартными звёздочками.

+ **Доступные значения:** true | false.
+ **Значение по умолчанию:** true.


#### `withoutSpinner`

+ **Тип данных:** логический.
+ **Описание:** Позволяет не показывать спиннер, показывающийся при различных асинхронных процессах,
                сопровождающих работу компонента (поиск пользователя, валидаций, авторизация и пр.)

+ **Доступные значения:** true | false.
+ **Значение по умолчанию:** false.


#### `simpleRegistration`

+ **Тип данных:** Логический.
+ **Описание:** Позволяет зарегистрировать пользователя без указания пароля.

  В случае значения true:

  1. Компонент не будет содержать поле для ввода пароля.
  2. Пароль будег сгенерирован на сервере. Для этого на сервер уйдёт дополнительный параметр `type` со значением `simple`.

+ **Доступные значения:** true | false.
+ **Значение о умолчанию:** false.


#### `Коллбэки`

##### `onMount`

+ **Тип данных:** Функция
+ **Описание:** Отрабатывает сразу в момент инициализации. На данный момент ещё не обработаны данные, введённые в поля компонента(не пройдены стадии валидации и поиска пользователя).
                Чисто визуально в данный момент вы всё ещё видите спиннер.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: В коллбэк данные не передаются. Без аргументов.


##### `onBeforeProcessDataOnRender`

+ **Тип данных:** Функция
+ **Описание:** Для обработки данных, введённых по умолчанию браузером с помощью ф-ции автокомплит, при рендеринге компонента осуществляется процесс валидации данных и поска пользователя.
                Наступает эта обработка по истечении 400 мс. Задержка связана с тем, что браузеру требуется некоторое время для вставки данных; при этом нет возможности завязаться на какое-либо
                событие при вставке данных автокомплитом. Поэтому эмперическим путём подобрана величина задержки - 400 мс перед началом обработки данных пользователя.
                Данный коллбэк выполняется сразу перед началом такой обработки данных.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: В коллбэк данные не передаются. Без аргументов.


##### `onRender`

+ **Тип данных:** Функция
+ **Описание:** Выполняется сразу после обработки пользовательских данных на стадии рендеринга компонента.
                Чисто визуально в этот момент пропадает спиннер.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: $component - jQuery-объект авторизационного компонента.


##### `onSubmit`

+ **Тип данных:** Функция
+ **Описание:** Выполняется сразу при сабмите формы, перед началом каких-либо проверок данных пользователя.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: В коллбэк данные не передаются. Без аргументов.


##### `onError`

+ **Тип данных:** Функция
+ **Описание:** Выполняется в случае возникновения ошибок на стадии обработки данных пользователя.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: errors - массив объектов ошибок, возникших на стадии обработки данных пользователя.


##### `onSearch`

+ **Тип данных:** Функция
+ **Описание:** Выполняется сразу после осуществления поска пользователя.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: data - объект, описывающий результаты поиска пользователя.

  В оъекте data хранятся данные двух типов:

  - data.type: тип поиска, по которому был найден или не найден юзер.

    Возможные значения:

    - `email` - искали только по мылу;
    - `emailAndPhone` - искали по мылу и телефону;
    - `emailButNotPhone` - искали по мылу и телефону, но нашли только по мылу;
    - `phoneInUsers` - искали по телефону в таблице пользователей;
    - `phoneInContacts` - искали по телефону в таблице контактов;
    - `phone` - искали по телефону.

  - data.user: объект с данными а найденном пользователе или null, если пользователь не был найден.


##### `onCompleted`

+ **Тип данных:** Функция
+ **Описание:** Выполняется по результату успешной авторизации/регистрации пользователя.

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: data - объект, описывающий процесс обработки пользовательских данных.

  Опишем объект data:

  - `data.prepareUserProcessType`: тип процесса обработки данных пользователя перед его авторизацией/регистрацией.

    Возможные значения:

    - `merge` - мёрдж данных одного пользователя в данные другого.
    - `increaese` - повышение уровня доступа пользователя через апдейт полей таблицы users.
    - `null`

  - `data.getResultProcessType`: тип результата процесса обработки пользовательских данных.

    Возможные значения:

    - `signIn` - авторизация пользователя.
    - `signUp` - регистрация пользователя.
    - `null`

  - `data.user`: данные об итоговом пользователе


##### `onProcessUserData`

+ **Тип данных:** Функция
+ **Описание:** Выполняется сразу перед началом обработки данных пользователя (первым этапом которой является валидация данных).

+ **Значение по умолчанию:** function() {}.
+ **Аргументы**: В коллбэк данные не передаются. Без аргументов.


### События

Компонент слушает ряд событий. Рассмотрим подробно каждое из данных событий.

#### `processUserData:authComponent`

+ **Описание:** Это, пожалуй, основное событие компонента. Его цель - запускать третью и четвёртую стадии работы компонента.
+ **Параметры:** Deferred-объект.
  Объект используется для того, чтобы слушать результаты обработки запущенных процессов.

+ **Пример**
  Наша задача запустить при необходимости мёрдж/повышение уровня авторизации пользователя, а после - регистрацию/авторизацию пользователя.

  **Решение**
  1. Создаём Deferred-объект, на котором будем слушать результат выполнения обозначенных в задаче процессов.

  ````javascript
  var $$processUserData =  $.Deferred();
  ````

  2. Далее триггерим событие на контейнере компонента (на том самом контейнере, на котором изначально инициализировали компонент),
    передавая в качестве аргумента созданный на предыдущей стадии Deferred.

  ````javascript
  $('.js-auth-component-container').trigger('processUserData:authComponent', [$processUserData]);
  ````

  Таким образом мы запустили процессы инкриза/мёрджа и регистрации/авторизации пользователей.

  3. Ждём ответ от компонента и обработываем полученные результаты.

  ````javascript
  $$processUserData.done(_onAfterProcessUserDataWithSuccess).fail(_onAfterProcessUserDataWithFail);
  ````
  `_onAfterProcessUserDataWithSuccess` - коллбэк, который выполняется в случае успешно выполненных инкриза/мёрджа и регистрации/авторизации пользователя.
  В коллбэк передаётся в качестве первого и единственного аргумента объект пользователя.

  `_onAfterProcessUserDataWithFail` - коллбэк, который выполняется в случае ошибки при выполнении инкриза/мёрджа или регистрации/авторизации пользователя.
  В коллбэк передаётся в качестве первого и единственного аргумента объект ошибок.

  Приведём код целиком:

  `````javascript
  var $$processUserData =  $.Deferred();

  $('.js-auth-component-container').trigger('processUserData:authComponent', [$processUserData]);

  $$processUserData.done(_onAfterProcessUserDataWithSuccess).fail(_onAfterProcessUserDataWithFail);
  `````


#### `synchronizeFields:authComponent`

+ **Описание:** Это событие позволяет синхронизировать поле внешнего компонента с полем авторизационного компонента.
  Направление потока данных - из поля внешнего компонента - в поле авторизационного компонента.

+ **Параметры:** Объект типа `{fieldType: fieldValue}`.
  Ключ(`fieldType`) - тип поля авторизационного компонента (phone, email, name, password).
  Значение(`fieldValue`) - значение соответствующего внешнего поля.

  Следует отметить, что синхронизация с внешним полем сохраняется до тех пор, пока пользователь не поменял значение таргетируемого поля авторизационного компонента. После изменения значения соответствующего поля авторизационного компонента - связь между полями теряется, чтобы избежать потенциальных коллизий.

+ **Пример**
  Допустим, авторизационный компонент встроили в форму, в которой также присутствует телефонное поле (.js-outer-phone-field),
  и необходимо синхронизировать данное поле с полем авторизационного компонента. Иначе говоря, необходимо после изменения значения внешнего поля
  компонента скопировать данное значение в телефонное поле авторизационного компонента.

  Для этого навешиваем на внешнее телефонное поле обработчик события change, в котором присваиваем значение из внешнего телефонного поля телефонному полю авторизационного компонента с использованием события synchronizeFields:authComponent.

  `````javascript
  $('.js-outer-phone-field').on('change', function() {
    $('.js-auth-component-container').trigger('synchronizeFields:authComponent', [{phone: $(this).val()}]);
  });
  `````


#### `subscribeOnFieldValue:authComponent`

+ **Описание:** Служит для того, чтобы подписаться на изменение одного или нескольких полей авторизационного компонента для работы с этими данными.
  Например, для той же синхронизации значения поля авторизационного компонента с соответствующим полем внешнего компонента - только в обратном порядке.
  Направление потока данных - из поля авторизационного компонента - в поле внешнего компонента.

+ **Параметры:**
  `fields`. Строка, содержащая названия полей, разделённые запятой, на которые необходимо подписаться.
  `callback`. Колбэк вызывается каждый раз при отработке события change для каждого из полей, перечисленных в предыдущей опции. В колбэк передаётся нативный объект события change.

+ **Пример**
  Допустим, необходимо подписаться на поля `phone` и `email` авторизационного компонента и передать их в поля .js-outer-phone-field и .js-outer-email-field соответственно.

  Для этого нам нужно, используя событие `subscribeOnFieldValue:authComponent`, подписаться на изменение соответствующих полей компонента,
  и в подписчике (коллбэке) присвоить внешним полям нужные значения.
  И, конечно же, подписываться (читай - триггерить ивент) будем на контейнере авторизационного компонента:

  ````javascript
  $('.js-auth-component-container').trigger('subscribeOnFieldValue:authComponent', ['phone, email', function(event) {
    var $target = $(event.target);

    $target.is('.js-input-email-auth') ?  $('.js-outer-email-field').val($target.val()) : $('.js-outer-phone-field').val($target.val());
  }]);
  `````

  Таким образом событие `subscribeOnFieldValue:authComponent` обеспечивает поток данных от авторизационного компонента к внешним полям компонента.

  События `synchronizeFields:authComponent` и `subscribeOnFieldValue:authComponent` могут быть использованы вместе для обеспечения двухстороннего соединения -
  одновременного потока данных из авторизационного компонента и в авторизационный компонент.

#### `unsubscribeFromFieldValue:authComponent`

+ **Описание:**
  Служит для того, чтобы отписаться от подписки на изменения полей компонента, описанной в предыдущем пункте.
  Подписка на изменения полей авторизационного компонента, описанная в предыдущем пункте, будет сохраняться до тех пор, пока вы не отписались от изменений.
  Для того, чтобы отписаться от них, и используется данное событие.

+ **Пример**
  Давайте отпишемся от чтения изменений, на которые мы подписались на предыдущем этапе:

  `````javascript
  $('.js-auth-component-container').trigger('unsubscribeFromFieldValue:authComponent', ['phone, email', function(event) {
    var $target = $(event.target);

    $target.is('.js-input-email-auth') ?  $('.js-outer-email-field').val($target.val()) : $('.js-outer-phone-field').val($target.val());
  }]);
  `````

#### `render:authComponent`

+ **Описание:** Используется для инициализации компонента.
  Триггерится событие на контейнере авторизационного компонента.
+ **Параметры:** Отсутствуют.
+ **Пример:**

  Проинициализируем авторизационный компонент на контейнере .js-auth-component-container:

  `````javascript
  $(‘.js-auth-component-container’).trigger(‘render:authComponent’);.
  `````


#### `register:authComponent`

+ **Описание:** Используется для регистрации пользователя.
  Триггерится событие на контейнере авторизационного компонента.
+ **Параметры:** Deferred-объект.
  Используется для того, чтобы обрабатывать результаты процесса регистрации.

+ Чтобы зарегистрировать пользователя, необходимо:

  1. Создать Deferred-объект:

  ````javascript
  var $$regUser = $.Deferred();
  ````

  2. Стриггерить событие на $doc с передачей Deferred-объекта и опций:

  `````javascript
  $doc.trigger(‘register:authComponent’, [$$regUser, options]);
  `````
  `options` - обязательный параметр. Используется для передачи параметра регистрации `withSID` и данных регистрации `data`.
  `withSID` - логический параметр, указывающий на то, следует или не следует регистрировать пользователя по SID-у. Возможные значения: true || false.
  `data` - объект, содержащий данные о пользователе для его регистрации.
  Объект характеризуется следующей структурой:
  {
    data: {
      profile_attributes: {
        name: 'Some Name'
      },
      email: 'some@email.com',
      phone: '79121234545',
      password: 12345
    }
  }

  3. Обрабатать результаты регистрации:

  `````javascript
  $$regUser.done(_onAfterRegUserWithSuccess).fail(_onAfterRegUserWithFail);
  `````

  `_onAfterRegUserWithSuccess` - коллбэк, который выполняется в случае успешно выполненных инкриза/мёрджа и регистрации/авторизации пользователя.
  В коллбэк передаётся в качестве первого и единственного аргумента объект пользователя.

  `_onAfterRegUserWithFail` - коллбэк, который выполняется в случае ошибки при выполнении инкриза/мёрджа или регистрации/авторизации пользователя.
  В коллбэк передаётся в качестве первого и единственного аргумента объект ошибок.

  **Пример 1**

  Зарегистрируем пользователя по SID-у с передачей имени пользователя.

  `````javascript
  var $$regUser = $.Deferred();

  $doc.trigger(‘register:authComponent’, [$$regUser, {
    withSID: true,
    data: {
      profile_attributes: {
        name: 'Some Name'
      }
    }
  }]);

  $$regUser
    .done(_onAfterRegUserWithSuccess)
    .fail(_onAfterRegUserWithFail);
  `````

  **Пример 2**

  Выполними стандартную регистрацию пользователя с передачей всех обязательных параметров: name, email, password.

  `````javascript
  var $$regUser = $.Deferred();

  $doc.trigger(‘register:authComponent’, [$$regUser, {
    data: {
      profile_attributes: {
        name: 'Some Name'
      },
      email: 'some@email.com',
      password: 12345
    }
  }]);

  $$regUser
    .done(_onAfterRegUserWithSuccess)
    .fail(_onAfterRegUserWithFail);
  `````

## Глобальные конфиги

Для корректной работы компонента необходимо подключить следующий набор конфигов.

### API URLs
`````javascript
// Создание/получение пользователей
app.config.api.usersURL = #{api_v1_users_url.to_json};

// Валидация phone, email, name
app.config.api.validationURL = #{api_v1_validation_url.to_json};

// Восстановление пароля
app.config.api.passwordURL = #{api_v1_password_url.to_json};

// Получение авторизационного кода по СМС
app.config.api.authCodeURL = #{api_v1_auth_code_url.to_json};

// Мёрдж пользователей
app.config.api.mergesURL = #{api_v1_merges_url.to_json};

// Инкриз авторизационного уровня пользователей
app.config.api.updateUserURL = #{api_v1_user_url('_id_')};

### URLs
`````javascript
// Регистрация по SID
app.config.usersRegistrationURL = #{create_user_url.to_json};

// Авторизация пользователя
app.config.usersSessionURL = #{users_session_url.to_json};
`````

Для подключения данных конфигов достаточно отрендерить два партиала, содержащие вышеперечисленный набор конфигов:

- [Из гема apress-clearance](https://github.com/abak-press/apress-clearance/blob/glamour-auth-component/app/views/apress/clearance/require/_common_config.html.haml)
- [Из гема apress-application](https://github.com/abak-press/apress-application/blob/master/app/views/apress/application/require/_common_config.html.haml)


### currentUser Data
`````javascript
// id текущего пользователя
app.config.currentUser.id = #{current_user.id.to_json};

// Есть ли имя у текущего пользователя
// Используется для определения - показывать ли для текущего пользователя поле для ввода имени
app.config.currentUser.withName = #{(signed_in? && current_user.profile.try(:[], :name).present?).to_json};

// Авторизован ли пользователь
app.config.isUserSigned = #{signed_in?.to_json};
`````

### modules
`````javascript
// Модуль, содержащий глобальные утилиты
app.modules.applicationUtils;

// Moдуль, отвечающий за кросс доменную авторизацию
app.modules.crossDomainAuthBridge;
`````

### Another Data
`````javascript
// Мобильная или десктопная версия приложения загружена в настоящий момент.
// Использутся для определения - для какой платформы следует отрендерить авторизационный компонент.
app.config.isMobile = true;

// Необходима ли кросс доменная авторизация на данной странице портала
app.config.crossDomainAuth = true;

// Сообщения об ошибках
app.config.api.errorMessages = {
  401: 'Сообщение о возникновении 401-й ошибки',
  403: 'Сообщение о возникновении 403-й ошибки'
};
`````

## Конфиги, принадлежащие исключительно компоненту
`````javascript
// Сообщение о некорректном количестве символов в пароле
app.config.authComponent.data.messages.invalidPasswordErrorMessage

// Контент трёх типов:
app.config.authComponent = {
  content: {
    signIn: {
      title: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.sign_in.title").to_json},
      buttonText: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.sign_in.button_text").to_json}
    },
    signUp: {
      title: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.sign_up.title").to_json},
      tip: #{Rails.application.config.clearance[:form_agreements].call(current_region, '%buttonText%').to_json},
      buttonText: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.sign_up.button_text").to_json}
    },
    common: {
      title: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.common.title").to_json},
      tip: #{Rails.application.config.clearance[:form_agreements].call(current_region, '%buttonText%').to_json},
      buttonText: #{t("clearance.templates.auth_component.#{local_assigns[:platform]}.common.button_text").to_json}
    }
  }
}
``````
Этот набор конфигов подключается [из гема apress-clearance](https://github.com/abak-press/apress-clearance/blob/glamour-auth-component/app/views/apress/clearance/require/_common_config.html.haml).

## Десктопная или мобильная версия компонента.
Компонент рендерится независимо для десктопной и мобильной платформ. Тип платформы, для которой необходимо отрендериться,
компонент определяет самостоятельно, исходя из значения глобальной опции app.config.isMobile.
